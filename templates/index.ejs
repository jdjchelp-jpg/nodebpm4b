<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= title %> - BPM4B
    </title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --secondary: #ec4899;
            --bg-dark: #0f172a;
            --glass: rgba(30, 41, 59, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --success: #22c55e;
            --error: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            background-image:
                radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(236, 72, 153, 0.15) 0px, transparent 50%);
            color: var(--text-main);
            min-height: 100vh;
            padding: 2rem 1rem;
            line-height: 1.5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            animation: fadeInDown 0.8s ease-out;
        }

        h1 {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(to right, #818cf8, #f472b6);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
            letter-spacing: -0.025em;
        }

        .version {
            color: var(--text-muted);
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        header p {
            color: var(--text-muted);
            font-size: 1.125rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .tool-card {
            background: var(--glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 2.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tool-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1.5rem;
        }

        h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .description {
            color: var(--text-muted);
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        input[type="text"],
        textarea {
            width: 100%;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 0.875rem 1.25rem;
            color: white;
            font-size: 1rem;
            transition: all 0.3s;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .file-drop-zone {
            border: 2px dashed var(--glass-border);
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(15, 23, 42, 0.4);
        }

        .file-drop-zone:hover,
        .file-drop-zone.active {
            border-color: var(--primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .file-drop-zone input[type="file"] {
            display: none;
        }

        .file-info {
            margin-top: 0.5rem;
            font-size: 0.875rem;
            color: var(--success);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 1rem;
            background: linear-gradient(135deg, var(--primary), var(--primary-hover));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            gap: 0.5rem;
        }

        .btn:hover {
            filter: brightness(1.1);
            transform: scale(1.02);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Chapter Styles */
        .chapter-section {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 2rem;
            border: 1px solid var(--glass-border);
        }

        .chapter-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .chapter-entries {
            margin-bottom: 1rem;
        }

        .chapter-entry {
            display: grid;
            grid-template-columns: 1fr 120px 48px;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            animation: slideIn 0.3s ease-out;
        }

        .remove-chapter-btn {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: all 0.3s;
        }

        .remove-chapter-btn:hover {
            background: var(--error);
            color: white;
        }

        .batch-import-area {
            margin-top: 1rem;
            display: none;
        }

        .batch-import-area.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        .batch-import-area textarea {
            min-height: 150px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }

        /* Progress */
        .progress-container {
            margin-top: 2rem;
            display: none;
        }

        .progress-container.active {
            display: block;
        }

        .progress-track {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 999px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            width: 0%;
            transition: width 0.3s ease;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 999px;
            font-size: 0.875rem;
            margin-top: 1rem;
            background: rgba(255, 255, 255, 0.05);
        }

        .status-badge.processing {
            background: rgba(99, 102, 241, 0.2);
            color: #818cf8;
        }

        .status-badge.success {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
        }

        .status-badge.error {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
        }

        /* Command Preview */
        .command-preview {
            background: #000;
            border-radius: 12px;
            padding: 1.25rem;
            margin-top: 2rem;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            position: relative;
            border: 1px solid var(--glass-border);
        }

        .command-preview header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .command-preview label {
            margin: 0;
            color: #6366f1;
            text-transform: none;
            letter-spacing: 0;
        }

        .copy-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .copy-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .command-preview code {
            color: #818cf8;
            word-break: break-all;
            display: block;
            line-height: 1.6;
        }

        /* Animations */
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 2.25rem;
            }

            .chapter-entry {
                grid-template-columns: 1fr 80px 40px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>MP3 to M4B Converter</h1>
            <p class="version">Version <%= version %>
            </p>
            <p>Convert MP3 files to M4B audiobook format with custom chapter markers.</p>
        </header>

        <div class="tool-card">
            <div class="tool-icon">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <path d="M9 18V5l12-2v13M6 21a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm12-3a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" />
                </svg>
            </div>
            <h2>MP3 to Audiobook</h2>
            <p class="description">Convert MP3s to M4B with chapters for the perfect listening experience on Apple Books
                and other audiobook players.</p>

            <form id="mp3Form">
                <div class="form-group">
                    <label>Audio File (MP3)</label>
                    <div class="file-drop-zone" id="dropZone">
                        <input type="file" id="mp3File" name="mp3_file" accept=".mp3,audio/mpeg" required>
                        <p id="filePrompt">Click or drag your MP3 file here</p>
                        <div class="file-info" id="fileInfo" style="display: none;"></div>
                    </div>
                </div>

                <div class="chapter-section">
                    <div class="chapter-controls">
                        <label style="margin: 0;">Chapter Markers (Optional)</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <button type="button" class="btn btn-secondary" id="toggleBatchBtn"
                                style="width: auto; padding: 6px 12px; font-size: 0.75rem;">Batch Import</button>
                            <button type="button" class="btn btn-secondary" id="exportChaptersBtn"
                                style="width: auto; padding: 6px 12px; font-size: 0.75rem;">Export .txt</button>
                        </div>
                    </div>

                    <div id="chaptersContainer"></div>

                    <div class="batch-import-area" id="batchArea">
                        <textarea id="batchInput"
                            placeholder="Paste chapter.txt content here...&#10;&#10;[CHAPTER]&#10;TIMEBASE=1/1000&#10;START=0&#10;title=Intro"
                            style="min-height: 150px; font-family: monospace; font-size: 13px;"></textarea>
                        <button type="button" class="btn btn-secondary" style="margin-top: 0.5rem;"
                            id="applyBatchBtn">Apply Batch Data</button>
                    </div>

                    <button type="button" class="btn btn-secondary" style="margin-top: 1rem; width: auto;"
                        id="addChapterBtn">
                        + Add Chapter
                    </button>
                </div>

                <div class="command-preview">
                    <header>
                        <label>FFmpeg Command (Self-Service)</label>
                        <button type="button" class="copy-btn" id="copyCommandBtn">Copy</button>
                    </header>
                    <code id="cmdOutput">ffmpeg -i input.mp3 -c:a aac -b:a 64k output.m4b</code>
                </div>

                <button type="submit" class="btn" id="submitBtn" style="margin-top: 2rem;">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" />
                    </svg>
                    Convert to M4B
                </button>
            </form>

            <div class="progress-container" id="progressContainer">
                <div class="progress-track">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div class="status-badge" id="statusBadge">Processing...</div>
            </div>
        </div>

        <footer style="text-align: center; margin-top: 3rem; color: var(--text-muted); font-size: 0.875rem;">
            <p>Requires FFmpeg to be installed on the server.</p>
        </footer>
    </div>

    <script>
        // DOM Elements
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('mp3File');
        const filePrompt = document.getElementById('filePrompt');
        const fileInfo = document.getElementById('fileInfo');
        const chaptersContainer = document.getElementById('chaptersContainer');
        const addChapterBtn = document.getElementById('addChapterBtn');
        const toggleBatchBtn = document.getElementById('toggleBatchBtn');
        const batchArea = document.getElementById('batchArea');
        const batchInput = document.getElementById('batchInput');
        const applyBatchBtn = document.getElementById('applyBatchBtn');
        const exportChaptersBtn = document.getElementById('exportChaptersBtn');
        const cmdOutput = document.getElementById('cmdOutput');
        const mp3Form = document.getElementById('mp3Form');
        const submitBtn = document.getElementById('submitBtn');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const statusBadge = document.getElementById('statusBadge');
        const copyCommandBtn = document.getElementById('copyCommandBtn');

        // State
        let selectedFile = null;
        let chapters = [];

        // File drop zone
        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('active');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('active');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('active');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFileSelect(e.target.files[0]);
            }
        });

        function handleFileSelect(file) {
            if (!file.name.endsWith('.mp3') && file.type !== 'audio/mpeg') {
                alert('Please select an MP3 file');
                return;
            }
            selectedFile = file;
            filePrompt.style.display = 'none';
            fileInfo.style.display = 'block';
            fileInfo.textContent = `${file.name} (${formatFileSize(file.size)})`;
            updateCommandPreview();
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            if (bytes < 1024 * 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            return (bytes / (1024 * 1024 * 1024)).toFixed(1) + ' GB';
        }

        // Chapter management
        addChapterBtn.addEventListener('click', () => {
            const id = Date.now();
            chapters.push({ id, title: '', start_time: '' });
            renderChapters();
        });

        function renderChapters() {
            chaptersContainer.innerHTML = '';
            chapters.forEach((chapter, index) => {
                const entry = document.createElement('div');
                entry.className = 'chapter-entry';
                entry.innerHTML = `
                    <input type="text" placeholder="Chapter title" value="${chapter.title}" data-index="${index}" data-field="title" required>
                    <input type="text" placeholder="Start (e.g., 0 or 0:00)" value="${chapter.start_time}" data-index="${index}" data-field="start_time" required>
                    <button type="button" class="remove-chapter-btn" data-index="${index}">Ã—</button>
                `;
                chaptersContainer.appendChild(entry);
            });

            // Add event listeners
            chaptersContainer.querySelectorAll('input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    const field = e.target.dataset.field;
                    chapters[index][field] = e.target.value;
                    updateCommandPreview();
                });
            });

            chaptersContainer.querySelectorAll('.remove-chapter-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    chapters.splice(index, 1);
                    renderChapters();
                    updateCommandPreview();
                });
            });

            updateCommandPreview();
        }

        // Batch import/export
        toggleBatchBtn.addEventListener('click', () => {
            batchArea.classList.toggle('active');
        });

        applyBatchBtn.addEventListener('click', () => {
            const text = batchInput.value.trim();
            if (!text) return;

            const parsedChapters = parseBatchChapters(text);
            if (parsedChapters.length > 0) {
                chapters = parsedChapters;
                renderChapters();
                batchArea.classList.remove('active');
            } else {
                alert('No valid chapters found in the batch data');
            }
        });

        function parseBatchChapters(text) {
            const lines = text.split('\n');
            const chapters = [];
            let currentChapter = null;

            for (let line of lines) {
                line = line.trim();
                if (line.startsWith('[CHAPTER]')) {
                    if (currentChapter) {
                        chapters.push(currentChapter);
                    }
                    currentChapter = { id: Date.now() + Math.random(), title: '', start_time: '' };
                } else if (currentChapter) {
                    if (line.startsWith('title=')) {
                        currentChapter.title = line.substring(6);
                    } else if (line.startsWith('START=')) {
                        const seconds = parseInt(line.substring(6)) / 1000;
                        currentChapter.start_time = seconds.toString();
                    }
                }
            }

            if (currentChapter) {
                chapters.push(currentChapter);
            }

            return chapters.filter(c => c.title && c.start_time);
        }

        exportChaptersBtn.addEventListener('click', () => {
            if (chapters.length === 0) {
                alert('No chapters to export');
                return;
            }

            let text = '';
            chapters.forEach(chapter => {
                const startMs = Math.round(parseFloat(chapter.start_time) * 1000);
                text += `[CHAPTER]\nTIMEBASE=1/1000\nSTART=${startMs}\ntitle=${chapter.title}\n\n`;
            });

            navigator.clipboard.writeText(text).then(() => {
                alert('Chapter data copied to clipboard!');
            }).catch(() => {
                alert('Failed to copy to clipboard');
            });
        });

        // Command preview
        function updateCommandPreview() {
            let cmd = 'ffmpeg -i input.mp3 -c:a aac -b:a 64k';
            if (chapters.length > 0) {
                cmd += ' [with chapters]';
            }
            cmd += ' output.m4b';
            cmdOutput.textContent = cmd;
        }

        copyCommandBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(cmdOutput.textContent).then(() => {
                const originalText = copyCommandBtn.textContent;
                copyCommandBtn.textContent = 'Copied!';
                setTimeout(() => {
                    copyCommandBtn.textContent = originalText;
                }, 2000);
            });
        });

        // Form submission
        mp3Form.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!selectedFile) {
                alert('Please select an MP3 file');
                return;
            }

            // Validate chapters
            const validChapters = chapters.filter(c => c.title && c.start_time);
            if (validChapters.length !== chapters.length) {
                alert('Please fill in all chapter fields or remove incomplete entries');
                return;
            }

            // Prepare form data
            const formData = new FormData();
            formData.append('mp3_file', selectedFile);
            if (validChapters.length > 0) {
                formData.append('chapters', JSON.stringify(validChapters));
            }

            // Show progress
            submitBtn.disabled = true;
            progressContainer.classList.add('active');
            progressBar.style.width = '0%';
            statusBadge.textContent = 'Uploading...';
            statusBadge.className = 'status-badge processing';

            try {
                const xhr = new XMLHttpRequest();

                xhr.upload.addEventListener('progress', (e) => {
                    if (e.lengthComputable) {
                        const percent = Math.round((e.loaded / e.total) * 50);
                        progressBar.style.width = percent + '%';
                    }
                });

                xhr.addEventListener('load', () => {
                    if (xhr.status === 200) {
                        progressBar.style.width = '100%';
                        statusBadge.textContent = 'Converting...';
                        statusBadge.className = 'status-badge processing';

                        // Download the file
                        const blob = xhr.response;
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        const originalName = selectedFile.name.replace(/\.[^/.]+$/, '');
                        a.download = originalName + '.m4b';
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);

                        statusBadge.textContent = 'Complete!';
                        statusBadge.className = 'status-badge success';
                        setTimeout(() => {
                            progressContainer.classList.remove('active');
                            submitBtn.disabled = false;
                        }, 2000);
                    } else {
                        throw new Error(xhr.statusText || 'Conversion failed');
                    }
                });

                xhr.addEventListener('error', () => {
                    throw new Error('Network error');
                });

                xhr.addEventListener('abort', () => {
                    statusBadge.textContent = 'Cancelled';
                    statusBadge.className = 'status-badge error';
                    submitBtn.disabled = false;
                });

                xhr.open('POST', '/api/mp3-to-m4b');
                xhr.responseType = 'blob';
                xhr.send(formData);

            } catch (error) {
                statusBadge.textContent = 'Error: ' + error.message;
                statusBadge.className = 'status-badge error';
                submitBtn.disabled = false;
            }
        });

        // Initialize
        updateCommandPreview();
    </script>
</body>

</html>